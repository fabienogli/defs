image: tiangolo/docker-with-compose

services:
  - docker:dind

stages:
  - build
  - test

before_script:
  - apk add go
  - go run utils/main.go

unit tests:
  stage: test
  script:
    - docker-compose up -d
    - docker-compose exec -T loadbalancer go test ./...
    - docker-compose exec -T supervisor go test ./...
    - docker-compose exec -T storage go test ./...
    - docker-compose down -v
  only:
    - develop

building:
  stage: build
  script:
    - docker-compose build
